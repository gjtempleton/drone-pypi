sudo: required

services:
  - docker

language: go
go:
  - 1.9

before_install:
  - sudo apt-get -qq update
  - sudo apt-get install -y python3-setuptools

script:
  - sed -i s/0.1.0/0.1.${TRAVIS_BUILD_NUMBER}/g testdata/setup.py
  - go vet
  - go test -cover -coverprofile=coverage.out
  - rm -rf dist
  - rm -rf drone_pypi_test.egg-info
  - |
    if test "${TRAVIS_TAG}" = ""; then
      go build -ldflags "-X main.build=${TRAVIS_BUILD_NUMBER}" -a -o release/linux/amd64/drone-pypi
    else
      go build -v -ldflags "-X main.version=${TRAVIS_TAG##v} -X main.build=${DRONE_BUILD_NUMBER}" -a -o release/linux/amd64/drone-pypi
    fi

# after_success:
#   - test $TRAVIS_PULL_REQUEST = false && docker login -u $DOCKER_USER -p $DOCKER_PASS
#     && export REPO=gjtempleton/drone-pypi && docker build -t $REPO:build --build-arg
#     GITSHA=$TRAVIS_COMMIT --build-arg BUILDDATE="`date`" . && docker tag $REPO:build
#     $REPO:travis-$TRAVIS_BUILD_NUMBER && if [[ "$TRAVIS_BRANCH" == "master" ]]; then
#     docker tag $REPO:build $REPO:latest; else docker tag $REPO:build $REPO:$TRAVIS_BRANCH;
#     fi && docker push $REPO

env:
  global:
  - PLUGIN_REPOSITORY=https://test.pypi.org/legacy/
  - PLUGIN_DISTRIBUTIONS=sdist
